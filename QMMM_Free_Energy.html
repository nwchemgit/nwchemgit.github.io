<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="canonical" href="https://nwchemgit.github.io/QMMM_Free_Energy.html">
  <link rel="shortcut icon" href="img/favicon.ico">
  <title>QMMM Free Energy - NWChem</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="css/theme.css" />
  <link rel="stylesheet" href="css/theme_extra.css" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "QMMM Free Energy";
    var mkdocs_page_input_path = "QMMM_Free_Energy.md";
    var mkdocs_page_url = "/QMMM_Free_Energy.html";
  </script>
  
  <script src="js/jquery-2.1.1.min.js" defer></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="." class="icon icon-home"> NWChem</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="./search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="Home.html">NWChem Manual</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="Download.html">How to download NWChem</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="Quantum-Mechanical-Methods.html">Quantum Mechanical Methods</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="Quantum-Molecular-Dynamics.html">Quantum Molecular Dynamics</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="Hybrid-Approaches.html">Hybrid Approaches</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="Other-Capabilities.html">Other Capabilities</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="Examples.html">NWChem Examples</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="Supplementary-Information.html">Supplementary Information</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="Compiling-NWChem.html">How to install NWChem</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="Benchmarks.html">Benchmarks performed with NWChem</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="Known-Bugs.html">Known Bugs</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="FAQ.html">FAQ</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="Tutorials.html">NWChem Tutorials</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="Forum.html">Forum</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="Archived-Forum.html">Archived Forum</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="EMSL_Arrows.html">EMSL Arrows</a>
                    </li>
                </ul>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="Containers.html">Containers</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href=".">NWChem</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".">Docs</a> &raquo;</li>
    
      
    
    <li>QMMM Free Energy</li>
    <li class="wy-breadcrumbs-aside">
      
        <a href="https://github.com/nwchemgit/nwchem-wiki/blob/master/QMMM_Free_Energy.md"
          class="icon icon-github"> Edit on GitHub</a>
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="qmmm-free-energy">QMMM Free Energy<a class="headerlink" href="#qmmm-free-energy" title="Permanent link">&para;</a></h1>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>Free energy capabilities of QM/MM module are at this point restricted to
calculations of free energy differences between two fixed configurations
of the QM region.</p>
<p><strong>Users must be warned that this the least automated QM/MM functionality
containing several calculation stages. Solid understanding of free
energy calculations is required to achieve a meaningful calculation.</strong></p>
<p>Description of the implemented methodology can be found in <a href="https://dx.doi.org/10.1063/1.2768343">the
following paper</a>. In this
approach the free energy difference between the two configurations of
the QM region (e.g. A and
B):</p>
<p><center></p>
<p>
<script type="math/tex">\Delta W_{A\to B}=-1/\beta \ln \langle (e^{-\beta (E_B-E_A)})  \rangle_{A}</script>
</p>
<p></center></p>
<p>is approximated as a sum of internal QM contribution and
solvation:</p>
<p><center></p>
<p>
<script type="math/tex">\Delta W_{A\to B}\approx\Delta W_{A\to B}^{int}+\Delta W_{A\to B}^{solv}</script>
</p>
<p></center></p>
<p>It is presumed that structures of A and B configurations are available
as restart files sharing <strong>common</strong> topology file.</p>
<h2 id="internal-contribution">Internal contribution<a class="headerlink" href="#internal-contribution" title="Permanent link">&para;</a></h2>
<p>The internal QM contribution is given by the differences in the internal
QM energies evaluated at the <strong>optimized</strong> MM environment:</p>
<p><center></p>
<p>
<script type="math/tex">\Delta W_{A\to B}^{int}=E_{B}^{int}-E_{A}^{int}</script>
</p>
<p></center></p>
<p>The internal QM energy is nothing more but a gas phase expression total
energy but evaluated with the wavefunction obtained in the presence of
the environment. To calculate internal QM contribution to free energy
difference one has to</p>
<ol>
<li>Optimize MM environment for each configuration</li>
<li>Perform total energy calculation for each configuration</li>
<li>Calculate internal energy difference</li>
</ol>
<p>Note that internal QM energy can be found in the QM/MM output file under
&ldquo;quantum energy internal&rdquo; name.</p>
<h2 id="solvation-contribution">Solvation contribution<a class="headerlink" href="#solvation-contribution" title="Permanent link">&para;</a></h2>
<p>The solvation contribution is evaluated by averaging energy difference
between A and B configurations of the QM system represented by a set of
ESP
charges.</p>
<p><center></p>
<p>
<script type="math/tex">\Delta W_{A\to B}^{solv}=-1/\beta \ln \langle (e^{-\beta (E_B^{ESP}-E_A^{ESP})})  \rangle_{A}</script>
</p>
<p></center></p>
<p>where <script type="math/tex">E_A^{ESP}</script> is the total energy of the system where QM region is
replaced by a set of fixed point ESP charges.</p>
<p>In majority of cases the A and B configuration are &ldquo;too far apart&rdquo; and
one step free energy calculation as shown above will not lead to
meaningful results. One solution is to introduce intermediate points
that bridge A and B configurations by linear interpolation</p>
<p><center></p>
<p>
<script type="math/tex">R_{\lambda_i} = (1-\lambda_i)R_A + \lambda_i R_B</script>
</p>
<p></center></p>
<p><center></p>
<p>
<script type="math/tex">Q_{\lambda_i} = (1-\lambda_i)Q_A + \lambda_i Q_B</script>
</p>
<p></center></p>
<p>where</p>
<p><center></p>
<p>
<script type="math/tex">\lambda_i = \frac {i}{n}, \quad i=0,..,n
\,\!</script>
</p>
<p></center></p>
<p>The solvation free energy difference can be then written as sum of
differences for the subintervals <script type="math/tex">\,\! [\lambda_i\to\lambda_{i+1}]</script>  :</p>
<p><center></p>
<p>
<script type="math/tex">
 \Delta W_{A\to B}^{\rm esp} = \sum_{i=0}^{n}\Delta W_{\lambda_i\to\lambda_{i+1}}^{\rm esp}
</script>
</p>
<p></center></p>
<p>To expedite the calculation it is convenient to use a double wide
sampling strategy where the free energy differences for the intervals
<script type="math/tex">\,\! [\lambda_{i-1}\to\lambda_{i}]</script>  and
<script type="math/tex">\,\! [\lambda_i\to\lambda_{i+1}]</script>  are calculated simultaneously by
sampling around <script type="math/tex">\,\!\lambda_{i}</script>   point. In the simplest case where we
use two subintervals
(n=2)</p>
<p><center></p>
<p>
<script type="math/tex">\Delta W_{A\to B}^{solv} \equiv \Delta W_{0\to 1}= \Delta W_{0\to 0.5}^{solv}+\Delta W_{0.5\to 1}^{solv}</script>
</p>
<p></center></p>
<p>or</p>
<p><center></p>
<p>
<script type="math/tex">\Delta W_{A\to B}^{\rm solv} = -\Delta W_{0.5\to 0}^{\rm solv}+\Delta W_{0.5 \to 1}^{\rm solv}</script>
</p>
<p></center></p>
<p>The following items are necessary:</p>
<ol>
<li>Restart file corresponding to either A or B configuration of the QM
    region (sharing the same topology file)</li>
<li>ESP charges for QM region in .esp format for both configurations</li>
<li>Coordinates for QM regions in .xyzi format for both configurations</li>
</ol>
<p>Both .esp and .xyzi files would be typically obtained during the
calculation of internal free energy (see above). ESP charges would be
generated in the perm directory during optimization of the MM region.
The xyzi is basically xyz structure file with an extra column that
allows to map coordinates of QM atoms to the overall system. The xyzi
file can also be obtained as part of calculation of internal free energy
by inserting</p>
<pre><code>set qmmm:region_print .true.
</code></pre>

<p>anywhere in the input file during energy calculation. <strong>Both xyzi and
esp files should be placed into the perm directory!!!</strong></p>
<p>In the input file the restart file is specified in the MD block
following the standard notation</p>
<pre><code>md
 system &lt; name of rst file without extension&gt;
 ...
end
</code></pre>

<p>while coordinates of QM region (xyzi files) and ESP charges (esp files)
are set using the following directives (at the top level outside of any
input blocks)</p>
<pre><code>set qmmm:fep_geom xxx_A.xyzi xxx_B.xyzi
set qmmm:fep_esp  xxx_A.esp xxx_B.esp
</code></pre>

<p>The current interpolation interval <script type="math/tex">\,\! [\lambda_i\to\lambda_{i+1}]</script>
<br />
for which free energy difference is calculated is defined as</p>
<pre><code>set qmmm:fep_lambda lambda_i lambda_i+1
</code></pre>

<p>To enable double wide sampling use the following directive</p>
<pre><code>set qmmm:fep_deriv .true.
</code></pre>

<p>If set, the above directive will perform both
<script type="math/tex">\,\! [\lambda_i\to\lambda_{i+1}]</script>  and
<script type="math/tex">\,\! [\lambda_i\to\lambda_{i-1}]</script>  calculations, where</p>
<p><center></p>
<p>
<script type="math/tex">\,\!
 \lambda_{i-1}=\lambda_i - (\lambda_{i+1}-\lambda_i)</script>
</p>
<p></center></p>
<p>The calculation proceeds in cycles, each cycle consisting of two phases.
First phase is generation of classical MD trajectory around
<script type="math/tex">\,\! \lambda_i</script> point. Second phase is processing of the generated
trajectory to calculate averages of relevant energy differences. The
number of MD steps in the first phase is controlled by the QM/MM
directive <span id="nsamples"></span></p>
<ul>
<li><strong><a href="Qmmm_nsamples.html">nsamples</a></strong>
    <integer number of MD steps for sampling></li>
</ul>
<p>This is a <strong>required</strong> directive for QM/MM free energy calculations.</p>
<p>Number of overall cycles is defined by the QM/MM directive</p>
<ul>
<li><strong><a href="Qmmm_ncycles.html">ncycles</a></strong> <integer number
    of cycles default 1></li>
</ul>
<p>In most cases explicit definition of QM/MM
<strong><a href="Qmmm_density.html">density</a></strong> and
<strong><a href="Qmmm_region.html">region</a></strong> should not be required.
The QM/MM <strong><a href="Qmmm_density.html">density</a></strong> will
automatically default to <strong>espfit</strong> and
<strong><a href="Qmmm_region.html">region</a></strong> to <strong>mm</strong>.</p>
<p>Prior to data collection for free energy calculations user may want to
prequilibrate the system, which can be achieved by <strong>equil</strong> keyword in
the MD block:</p>
<pre><code> md
  ... 
 equil &lt;number of equilibration steps&gt;
 end
</code></pre>

<p>Other parameters (e.g. temperature and pressure can be also set in the
MD block.</p>
<p>The actual QM/MM solvation free energy calculation is invoked through
the following task directive</p>
<pre><code>task qmmm fep
</code></pre>

<p>The current value of solvation free energy differences may be tracked
though</p>
<pre><code>grep free &lt;name of the output file&gt;
</code></pre>

<p>The first number is a forward (<script type="math/tex">\,\! [\lambda_i\to\lambda_{i+1}]</script>)
free energy difference and second number is backward
(<script type="math/tex">\,\! [\lambda_i\to\lambda_{i-1}]</script>) free energy difference, both in
kcal/mol. The same numbers can also be found in the 4th and 6th columns
of <system>.thm file but this time in <strong>atomic units</strong>.</p>
<p>The same <system>.thm file can also be used to continue from the prior
calculation. This will require the presence of</p>
<pre><code> set qmmm:extend .true.
</code></pre>

<p>directive, the <system>.thm file, and the appropriate rst file.</p>
<p>Here is an <a href="QMMM_FEP_Example.html">example of the input file for QM/MM solvation free energy
calculation</a>.</p>
              
            </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
          <a href="https://github.com/nwchemgit/nwchem-wiki/" class="fa fa-github" style="float: left; color: #fcfcfc"> GitHub</a>
      
      
      
    </span>
</div>
    <script>var base_url = '.';</script>
    <script src="js/theme.js" defer></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_HTML" defer></script>
      <script src="search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
